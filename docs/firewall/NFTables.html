<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NFTables &mdash; Linux server mitigations</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Packet filtering" href="PF.html" />
    <link rel="prev" title="IPTables" href="IPTables.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Linux server mitigations
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Separation and isolation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../separation/README.html">Separation and isolation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../separation/Chroot-jails.html">Chroot jails</a></li>
<li class="toctree-l1"><a class="reference internal" href="../separation/Communication.html">Communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../separation/Docker.html">Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../separation/FreeBSD-jails.html">FreeBSD jails</a></li>
<li class="toctree-l1"><a class="reference internal" href="../separation/KVM.html">KVM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../separation/Services-audit.html">Services audit</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">SSH</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ssh/README.html">SSH</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ssh/Authentication-error.html">Authentication error</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ssh/ForwardAgent.html">ForwardAgent</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ssh/Harden-ssh-server.html">Harden ssh server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ssh/Installing-SSH.html">Installing SSH</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ssh/Jumping-hosts.html">Jumping hosts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ssh/Keeping-current.html">Keeping current</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ssh/Key-management.html">Key management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ssh/ProxyCommand.html">ProxyCommand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ssh/ProxyJump.html">ProxyJump</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">VPN</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vpn/README.html">VPN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vpn/OpenVPN.html">OpenVPN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vpn/strongSwan.html">strongSwan</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">VNC</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vnc/README.html">VNC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vnc/Connection-refused.html">Connection refused</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vnc/Securing-sessions.html">Securing sessions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vnc/TigerVNC.html">TigerVNC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vnc/TightVNC.html">TightVNC</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Public key infrastructure (PKI)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../pki/README.html">PKI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pki/Internal-PKI.html">Internal PKI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pki/Lets-Encrypt.html">Let’s Encrypt</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pki/PAM.html">Pluggable Authentication Modules (PAM)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pki/Problems.html">Problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pki/TLS-SSL.html">TLS/SSL</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Logfiles</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../logfiles/README.html">Logfiles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../logfiles/Centralised-logging.html">Centralised logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../logfiles/Commands.html">Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../logfiles/Logrotate.html">Logrotate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../logfiles/Path-of-a-common-intruder.html">Path of a common intruder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../logfiles/rsyslogd.html">Syslog</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Backup</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../backups/README.html">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backups/Simple-script.html">Simple script</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">HIDS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ids/README.html">HIDS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ids/Maltrail.html">Maltrail</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ids/Samhain.html">Samhain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ids/Snort.html">Snort</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Firewall</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="README.html">Firewalls</a></li>
<li class="toctree-l1"><a class="reference internal" href="Blacklists.html">Blacklists</a></li>
<li class="toctree-l1"><a class="reference internal" href="Fail2ban.html">Fail2ban</a></li>
<li class="toctree-l1"><a class="reference internal" href="FireHOL.html">FireHOL</a></li>
<li class="toctree-l1"><a class="reference internal" href="FirewallD.html">FirewallD</a></li>
<li class="toctree-l1"><a class="reference internal" href="IPTables.html">IPTables</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">NFTables</a></li>
<li class="toctree-l1"><a class="reference internal" href="PF.html">Packet filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="Port-spoofing.html">Port spoofing</a></li>
<li class="toctree-l1"><a class="reference internal" href="SSHguard.html">SSHguard</a></li>
<li class="toctree-l1"><a class="reference internal" href="UFW.html">UFW</a></li>
<li class="toctree-l1"><a class="reference internal" href="WAF.html">Web Application Firewall WAF</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Healthy SA habits</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../habits/README.html">Healthy habits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../habits/Chattr.html">Chattr</a></li>
<li class="toctree-l1"><a class="reference internal" href="../habits/Plain-language.html">Plain language</a></li>
<li class="toctree-l1"><a class="reference internal" href="../habits/Puppet.html">Puppet</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">All mitigations</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://tymyrddin.github.io/mitigations/">Overview</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Linux server mitigations</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>NFTables</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/docs/firewall/NFTables.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="nftables">
<h1>NFTables<a class="headerlink" href="#nftables" title="Permalink to this heading"></a></h1>
<p>Available upstream since Linux kernel 3.13..</p>
<section id="basic-idea">
<h2>Basic idea<a class="headerlink" href="#basic-idea" title="Permalink to this heading"></a></h2>
<p>Got an idea! Working on it … //Warning: untested!//</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>flush ruleset

table inet filter {

    set inet filter tcp_port_out { type inet_service; 
        elements = { 
            53,    # DNS
            11371, # OpenPGP HTTP Keyserver
            2200,  # SSH
            80,    # HTTP
            443,   # HTTPS
        }
    }
    
    set inet filter tcp_port_in { type inet_service; 
        elements = { 
            2200,  # SSH
        }
    }
    
    set inet filter udp_port_out { type inet_service;  
        elements = { 
            53,    # DNS
            123,   # NTP
        }
    }
    
    set inet filter udp_port_in { type inet_service; 
        elements = {
        }
    }
    
    set inet filter user_out { type uid;      
        elements = {
        }
    }
    
    set inet filter user_in { type uid;        
        elements = {
        }
    }
    
    set tcp_scan_ports { type inet_service; 
        elements = {
            22,    # SSH
            23,    # Telnet
            1433,  # MS SQL Login
            8080,  # HTTP Alternate
            50661, # Apple Xsan   
        }
    }
    
    set udp_scan_ports { type inet_service; 
        elements = {
            53,    # DNS
            5060,  # SIP
            53413, # Netis backdoor
        }
    }

    chain base_checks {
        # allow established/related connections
        ct state {established, related} accept
        # early drop of invalid connections
        ct state invalid log prefix &quot;Invalid &quot; drop
    }
    
    chain input {
        type filter hook input priority 0; 

        # Accept on localhost
        iifname lo accept
        jump base_checks
        
        # Accept neighbour discovery
        ip6 nexthdr icmpv6 icmpv6 type { nd-neighbor-solicit,  nd-router-advert, \
        nd-neighbor-advert } accept
        
        # Accept ping
        ip protocol icmp type { echo-request } accept
        
        # Allow IGMP
        ip protocol igmp accept
        
        tcp  dport @tcp_port_in ct state new accept
        udp  dport @udp_port_in ct state new accept
        meta skuid @user_in ct state new accept
        
        tcp dport @tcp_scan_ports drop
        udp dport @udp_scan_ports drop
        
        # Count and drop any other traffic
        counter log prefix &quot;Drop_in &quot; drop
    }
    
    # Not a gateway. We do not forward. 
    chain forward {
        type filter hook forward priority 0; policy drop;       
        jump base_checks
    }
    
    chain output {
        type filter hook output priority 0; 
        
        # Accept from localhost
        oifname lo accept
        jump base_checks
        
        # Accept neighbour discovery
        ip6 nexthdr icmpv6 icmpv6 type { nd-neighbor-solicit,  nd-router-advert, \
        nd-neighbor-advert } accept

        # Accept ping
        ip protocol icmp type { echo-request } accept

        tcp  dport @tcp_port_out ct state new accept
        udp  dport @udp_port_out ct state new accept
        meta skuid @user_out ct state new accept
        
        # Count and drop any other traffic
        counter log prefix &quot;Drop_out &quot; drop    
    }
</pre></div>
</div>
</section>
<section id="kernel">
<h2>kernel<a class="headerlink" href="#kernel" title="Permalink to this heading"></a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[*] Networking support  ---&gt;
    Networking options  ---&gt;
        [*] Network packet filtering framework (Netfilter)  ---&gt;
            Core Netfilter Configuration  ---&gt;
                &lt;M&gt; Netfilter nf_tables support
                &lt;M&gt;   Netfilter nf_tables conntrack module
                &lt;M&gt;   Netfilter nf_tables counter module
                &lt;M&gt;   Netfilter nf_tables log module
                &lt;M&gt;   Netfilter nf_tables limit module
                &lt;M&gt;   Netfilter nf_tables masquerade support
                &lt;M&gt;   Netfilter nf_tables nat module
            IP: Netfilter Configuration  ---&gt;
                &lt;M&gt; IPv4 nf_tables support
                &lt;M&gt;   IPv4 nf_tables route chain support
                &lt;M&gt; IPv4 packet rejection
                &lt;M&gt; IPv4 NAT
                &lt;M&gt;   IPv4 nf_tables nat chain support
                &lt;M&gt;   IPv4 masquerade support
                &lt;M&gt;   IPv4 masquerading support for nf_tables
</pre></div>
</div>
</section>
<section id="configuration-files">
<h2>Configuration files<a class="headerlink" href="#configuration-files" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>Create a main table, for example</p>
<ul>
<li><p>A file <code class="docutils literal notranslate"><span class="pre">/etc/nftables/main_config.conf</span></code> where elements can be added</p></li>
<li><p>A file <code class="docutils literal notranslate"><span class="pre">/etc/nftables/main.conf</span></code> with a skeleton inet table</p></li>
</ul>
</li>
<li><p>Set up the activation scripts</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">/etc/nftables.conf</span></code> as startup script (flushes rule set)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/etc/nftables/reload_main.conf</span></code> as reload script (deletes table)</p></li>
</ul>
</li>
</ul>
</section>
<section id="sshguard">
<h2>Sshguard<a class="headerlink" href="#sshguard" title="Permalink to this heading"></a></h2>
<p>To integrate with [SSHguard], edit <code class="docutils literal notranslate"><span class="pre">/etc/sshguard.conf</span></code> and change the value of <code class="docutils literal notranslate"><span class="pre">BACKEND</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>BACKEND=&quot;/usr/lib/sshguard/sshg-fw-nft-sets&quot;
</pre></div>
</div>
<p>When starting or enabling the <code class="docutils literal notranslate"><span class="pre">sshguard.service</span></code>, two new tables named sshguard in the ip and ip6 address families are added which filter incoming traffic through sshguard’s list of IP addresses. The chains in the sshguard table have a priority of -10 and will be processed before other rules of lower priority.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="IPTables.html" class="btn btn-neutral float-left" title="IPTables" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="PF.html" class="btn btn-neutral float-right" title="Packet filtering" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
        <a href="https://unseen-uni.netlify.app/">Unseen University</a>, 2022

  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script> 

</body>
</html>